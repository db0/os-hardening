---

- name: "SECTION | {{ SEC_ID_ENSURE_AUDITING_ENABLED }} | Ensure auditing is enabled"
  include_tasks: ensure_auditing_enabled.yml

- name: "SECTION | {{ SEC_ID_CONFIGURE_DATA_RETENTION }} | Configure Data Retention"
  include_tasks: configure_data_retention.yml

- name: "{{ SEC_ID_ENSURE_DATE_TIME_EVENTS_COLLECTED }} | L2 | PATCH | Ensure events that modify date and time information are collected"
  template:
      src: audit/time_change.rules.j2
      dest: /etc/audit/rules.d/time_change.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_DATE_TIME_EVENTS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.3

- name: "{{ SEC_ID_ENSURE_USER_GROUP_EVENTS_COLLECTED }} | L2 | PATCH | Ensure events that modify user/group information are collected"
  template:
      src: audit/identity.rules.j2
      dest: /etc/audit/rules.d/identity.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_USER_GROUP_EVENTS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.4

- name: "{{ SEC_ID_ENSURE_NETWORK_ENVIRONMENT_EVENTS_COLLECTED }} | L2 | PATCH | Ensure events that modify the system's network environment are collected"
  template:
      src: audit/system_local.rules.j2
      dest: /etc/audit/rules.d/system_local.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_NETWORK_ENVIRONMENT_EVENTS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.5

- name: "{{ SEC_ID_ENSURE_MANDATORY_ACCESS_CONTROL_EVENTS_COLLECTED }} | L2 | PATCH | Ensure events that modify the system's Mandatory Access Controls are collected"
  template:
      src: audit/MAC_policy.rules.j2
      dest: /etc/audit/rules.d/MAC_policy.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_MANDATORY_ACCESS_CONTROL_EVENTS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.6

- name: "{{ SEC_ID_ENSURE_LOGIN_LOGOUT_EVENTS_COLLECTED }} | L2 | PATCH | Ensure login and logout events are collected"
  block:
      - name: "{{ SEC_ID_ENSURE_LOGIN_LOGOUT_EVENTS_COLLECTED }} | L2 | AUDIT | Ensure login and logout events are collected | Check for pam_fallock or pam_tally2"
        shell: grep pam_tally2.so /etc/pam.d/system-auth /etc/pam.d/password-auth
        changed_when: false
        failed_when: false
        register: linuxcis_4_1_7_tally2_check
        tags:
            - skip_ansible_lint

      - name: "{{ SEC_ID_ENSURE_LOGIN_LOGOUT_EVENTS_COLLECTED }} | L2 | PATCH | Ensure login and logout events are collected | Set login and logout events"
        template:
            src: audit/logins.rules.j2
            dest: /etc/audit/rules.d/logins.rules
            owner: root
            group: root
            mode: 0600
        notify: restart auditd
  when:
      - SEC_ID_ENSURE_LOGIN_LOGOUT_EVENTS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.7

- name: "{{ SEC_ID_ENSURE_SESSION_INIT_INFO_COLLECTED }} | L2 | PATCH | Ensure session initiation information is collected"
  template:
      src: audit/session.rules.j2
      dest: /etc/audit/rules.d/session.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_SESSION_INIT_INFO_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.8

- name: "{{ SEC_ID_ENSURE_DISC_ACC_CTRL_PERM_COLLECTED }} | L2 | PATCH | Ensure discretionary access control permission modification events are collected"
  template:
      src: audit/perm_mod.rules.j2
      dest: /etc/audit/rules.d/perm_mod.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_SESSION_INIT_INFO_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - automated
      - rule_4.1.9

- name: "{{ SEC_ID_ENSURE_UNAUTH_FILE_ACCESS_COLLECTED }} | L2 | PATCH | Ensure unsuccessful unauthorized file access attempts are collected"
  template:
      src: audit/access.rules.j2
      dest: /etc/audit/rules.d/access.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_UNAUTH_FILE_ACCESS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.10

- name: "{{ SEC_ID_ENSURE_PRIV_COMMANDS_COLLECTED }} | L2 | PATCH | Ensure use of privileged commands is collected"
  block:
      - name: "{{ SEC_ID_ENSURE_PRIV_COMMANDS_COLLECTED }} | L2 | AUDIT | Ensure use of privileged commands is collected"
        shell: for i in  $(df | grep '^/dev' | awk '{ print $NF }'); do find $i -xdev -type f -perm -4000 -o -type f -perm -2000 2>/dev/null; done
        register: priv_procs
        changed_when: false
        check_mode: false

      - name: "{{ SEC_ID_ENSURE_PRIV_COMMANDS_COLLECTED }} | L2 | PATCH | Ensure use of privileged commands is collected"
        template:
            src: audit/priv_commands.rules.j2
            dest: /etc/audit/rules.d/priv_commands.rules
            owner: root
            group: root
            mode: 0600
        notify: restart auditd
  when:
      - SEC_ID_ENSURE_PRIV_COMMANDS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.11

- name: "{{ SEC_ID_ENSURE_FS_MOUNTS_COLLECTED }} | L2 | PATCH | Ensure successful file system mounts are collected"
  template:
      src: audit/mounts.rules.j2
      dest: /etc/audit/rules.d/mounts.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_FS_MOUNTS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - automated
      - rule_4.1.12

- name: "{{ SEC_ID_ENSURE_FILE_DELETION_EVENTS_COLLECTED }} | L2 | PATCH | Ensure file deletion events by users are collected"
  template:
      src: audit/deletion.rules.j2
      dest: /etc/audit/rules.d/deletion.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_FILE_DELETION_EVENTS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.13

- name: "{{ SEC_ID_ENSURE_SUDOERS_CHANGES_COLLECTED }} | L2 | PATCH | Ensure changes to system administration scope (sudoers) is collected"
  template:
      src: audit/scope.rules.j2
      dest: /etc/audit/rules.d/scope.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_SUDOERS_CHANGES_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.14

- name: "{{ SEC_ID_ENSURE_SUDO_COMMANDS_COLLECTED }} | L2 | PATCH | Ensure system administrator command executions (sudo) are collected"
  template:
      src: audit/actions.rules.j2
      dest: /etc/audit/rules.d/actions.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_SUDO_COMMANDS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.15

- name: "{{ SEC_ID_ENSURE_KERNEL_MODULE_ACTIONS_COLLECTED }} | L2 | PATCH | Ensure kernel module loading and unloading is collected"
  template:
      src: audit/modules.rules.j2
      dest: /etc/audit/rules.d/modules.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_KERNEL_MODULE_ACTIONS_COLLECTED not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.16

- name: "{{ SEC_ID_ENSURE_AUDIT_CONFIG_IMMUTABLE }} | L2 | PATCH | Ensure the audit configuration is immutable"
  template:
      src: audit/99_finalize.rules.j2
      dest: /etc/audit/rules.d/99_finalize.rules
      owner: root
      group: root
      mode: 0600
  notify: restart auditd
  when:
      - SEC_ID_ENSURE_AUDIT_CONFIG_IMMUTABLE not in disabled_cis_rules
      - linuxcis_level2
  tags:
      - level2
      - auditd
      - patch
      - rule_4.1.17
