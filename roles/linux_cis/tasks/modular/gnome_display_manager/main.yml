---

- name: "{{ SEC_ID_ENSURE_GDM_IS_REMOVED }} | L2 | PATCH | Ensure GNOME Display Manager is removed"
  block:
      - name: "{{ SEC_ID_ENSURE_GDM_IS_REMOVED }} | L2 | AUDIT | Ensure GNOME Display Manager is removed | check runlevel"
        fail:
            msg: "System is at runlevel 5 and GDM is installed this can only be removed at Lvl <= 3"
        when:
            - ansible_env.SHLVL > 3

      - name: "{{ SEC_ID_ENSURE_GDM_IS_REMOVED }} | L2 | AUDIT | Ensure GNOME Display Manager is removed | Remove package"
        package:
            name: gdm
            state: absent
  when:
      - "'gdm' in ansible_facts.packages"
      - not linuxcis_gui
      - SEC_ID_ENSURE_GDM_IS_REMOVED not in disabled_cis_rules
  tags:
      - rule_1.8.1
      - level_1

- name: "{{ SEC_ID_ENSURE_GDM_LOGIN_BANNER_CONFIGURED }} | L1 | PATCH | Ensure GDM login banner is configured"
  block:
      - name: "{{ SEC_ID_ENSURE_GDM_LOGIN_BANNER_CONFIGURED }} | L1 | PATCH | Ensure GDM login banner is configured | gdm profile"
        lineinfile:
            path: /etc/dconf/profile/gdm
            regexp: "^{{ item.regexp }}"
            line: "{{ item.line }}"
            state: present
            create: true
            mode: 0644
            owner: root
            group: root
        with_items:
            - {regexp: 'user-db', line: 'user-db:user' }
            - {regexp: 'system-db', line: 'system-db:gdm' }
            - {regexp: 'file-db', line: 'file-db:/usr/share/gdm/greeter-dconf-defaults' }

      - name: "{{ SEC_ID_ENSURE_GDM_LOGIN_BANNER_CONFIGURED }} | L1 | PATCH | Ensure GDM login banner is configured | banner"
        lineinfile:
            path: /etc/dconf/db/gdm.d/01-banner-message
            regexp: "^{{ item.regexp }}"
            line: "{{ item.line }}"
            state: present
            create: true
            mode: 0644
            owner: root
            group: root
        with_items:
            - { regexp: '\[org\/gnome\/login-screen\]', line: '[org/gnome/login-screen]' }
            - { regexp: 'banner-message-enable', line: 'banner-message-enable=true' }
            - { regexp: 'banner-message-text', line: "banner-message-text='{{ linuxcis_warning_banner }}' " }
  when:
      - "'gdm' in ansible_facts.packages"
      - not linuxcis_gui
      - SEC_ID_ENSURE_GDM_LOGIN_BANNER_CONFIGURED not in disabled_cis_rules
  tags:
      - rule_1.8.2
      - level_1

- name: "{{ SEC_ID_ENSURE_LAST_LOGGED_USER_DISPLAYED }} | L1 | PATCH | Ensure last logged in user display is disabled | banner"
  block:
      - name: "{{ SEC_ID_ENSURE_LAST_LOGGED_USER_DISPLAYED }} | L1 | PATCH | Ensure last logged in user display is disabled | gdm profile"
        lineinfile:
            path: /etc/dconf/profile/gdm
            regexp: "^{{ item.regexp }}"
            line: "{{ item.line }}"
            state: present
            create: true
            mode: 0644
            owner: root
            group: root
        with_items:
            - {regexp: 'user-db', line: 'user-db:user' }
            - {regexp: 'system-db', line: 'system-db:gdm' }
            - {regexp: 'file-db', line: 'file-db:/usr/share/gdm/greeter-dconf-defaults' }

      - name: "{{ SEC_ID_ENSURE_LAST_LOGGED_USER_DISPLAYED }} | L1 | PATCH | Ensure last logged in user display is disabled | login screen"
        lineinfile:
            path: /etc/dconf/db/gdm.d/00-login-screen
            regexp: "^{{ item.regexp }}"
            line: "{{ item.line }}"
            state: present
            create: true
            mode: 0644
            owner: root
            group: root
        with_items:
            - { regexp: '\[org\/gnome\/login-screen\]', line: '[org/gnome/login-screen]' }
            - { regexp: 'disable-user-list', line: 'disable-user-list=true' }
  when:
      - "'gdm' in ansible_facts.packages"
      - not linuxcis_gui
      - SEC_ID_ENSURE_LAST_LOGGED_USER_DISPLAYED not in disabled_cis_rules
  tags:
      - rule_1.8.3
      - level_1

- name: "{{ SEC_ID_ENSURE_XDCMP_NOT_ENABLED }} | L1 | PATCH | Ensure XDCMP is not enabled"
  lineinfile:
      path: /etc/gdm/custom.conf
      regexp: ^Enable=true
      state: absent
      create: true
      owner: root
      group: root
      mode: 0644
  when:
      - "'gdm' in ansible_facts.packages"
      - not linuxcis_gui
      - SEC_ID_ENSURE_XDCMP_NOT_ENABLED not in disabled_cis_rules
  tags:
      - rule_1.8.4
